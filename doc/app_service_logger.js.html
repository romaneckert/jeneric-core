<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>app/service/logger.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_abstract.html">app/abstract</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_handler_logger_log.html">app/handler/logger/log</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="app_handler_logger_log.html#handle">handle</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_kernel.html">app/kernel</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_service_data.html">app/service/data</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_service_logger.html">app/service/logger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="app_service_logger.html#log">log</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_service_marytts.html">app/service/marytts</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_service_observer.html">app/service/observer</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_service_server.html">app/service/server</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="app_util.html">app/util</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="common_entity_log.html">common/entity/log</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="web_abstract.html">web/abstract</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="web_kernel.html">web/kernel</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">app/service/logger.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const path = require('path');
const AbstractService = require('../abstract-service');

/**
 * @classDesc logger
 * @exports app/service/logger
 * @class
 */
class Logger extends AbstractService {
    constructor(config) {

        super();

        this._config = {
            directory : 'var/logs',
            levels : {
                0 : {
                    name : 'emergency',
                    console : true,
                    color: "\x1b[31m"
                },
                1 : {
                    name : 'alert',
                    console : true,
                    color: "\x1b[31m"
                },
                2 : {
                    name : 'critical',
                    console : true,
                    color: "\x1b[31m"
                },
                3 : {
                    name : 'error',
                    console : true,
                    color: "\x1b[31m"
                },
                4 : {
                    name : 'warning',
                    console : true,
                    color: "\x1b[33m"
                },
                5 : {
                    name : 'notice',
                    console : true,
                    color: "\x1b[34m"
                },
                6 : {
                    name : 'info',
                    console : true,
                    color: "\x1b[34m"
                },
                7 : {
                    name : 'debug',
                    console : true,
                    color: "\x1b[37m"
                },
                8 : {
                    name : 'observe',
                    console : false,
                    color: "\x1b[37m"
                }
            }
        };
        
        // merge config
        this.utils.object.merge(this._config, config);
        
        // ensure log files exists
        for(let code in this._config.levels) {

            this.fs.ensureFileExists(
                path.join(
                    path.dirname(require.main.filename),
                    '../',
                    this._config.directory,
                    this._config.levels[code].name + '.log',
                )
            );
        }

        this._logsToSaveQueue = [];
        this._history = [];
    }

    /**
     * @param message
     * @param meta
     * @param moduleDefinition
     * @param stack
     * @param code
     */
    log(message, meta, moduleDefinition, stack, code) {

        let module = '';

        if('object' === typeof moduleDefinition) {
            module = moduleDefinition.toString();
        }

        let date = new Date();

        // remove line breaks
        message = message.replace(/(\r?\n|\r)/gm, ' ');

        // remove whitespaces and the beginning and the end
        message = this.utils.string.cast(message).trim();

        meta = this.utils.string.cast(meta);

        if('object' !== typeof stack) {
            stack = this.utils.error.stack(new Error());
            stack.shift();
            stack.shift();
        }
        stack = this._stackToString(stack);

        let output = '[' + this._dateStringFromDate(date) + '] ';
        output += '[' + this._config.levels[code].name + '] ';
        output += '[' + module + '] ';
        output += '[' + message + ']';

        if(meta.length > 0) output += ' [' + meta + ']';
        output += ' [' + stack + ']';

        // write log entry in specific log file
        let pathToLogFile = path.join(
            path.dirname(require.main.filename),
            '../',
            this._config.directory,
            this._config.levels[code].name + '.log'
        );

        this.fs.appendFileSync(pathToLogFile, output + '\n');

        // write log entry to console
        if(this._config.levels[code].console) {

            let consoleOutput = message + ' ';
            consoleOutput += '[' + module + '] ';
            if(meta.length > 0) consoleOutput += '[' + meta + '] ';
            consoleOutput += '[' + stack + ']';

            console.log(this._config.levels[code].color , consoleOutput, "\x1b[0m") ;
        }

        let log = new this.entities.log(code, date, message, meta, module, stack);

        // remove older entries if log history greater then 200
        if(this._history.length > 200) this._history.shift();

        // add current log to history
        this._history.push(log);

        // call log handler
        this.handler.logger.log.handle(log);

        // save log to db
        this._save(log);
    }

    _save(log) {

        // remove older entries if log to save queue greater then 200
        if(this._logsToSaveQueue.length > 200) this._logsToSaveQueue.shift();

        this._logsToSaveQueue.push(log);

        if(this._kernel.services.data.ready) {

            for(let logToSave of this._logsToSaveQueue) {
                this._kernel.services.data.add(logToSave);
            }

            this._logsToSaveQueue = [];
        }

    }

    _stackToString(stack) {
        let outputs = [];

        for(let entry of stack) {

            let processParentDir = path.dirname(process.cwd());

            if(entry.path.includes(processParentDir)) {

                let scriptPath = entry.path.replace(processParentDir, '');

                outputs.push(entry.method + ' ' + scriptPath + ':' + entry.row);
            }
        }

        return outputs.join(' &lt;- ');
    }

    /**
     * @param {date} date
     * @returns {string} date
     * @private
     */
    _dateStringFromDate(date) {

        return date.getFullYear()
            + '-'
            + ('0' + (date.getMonth() + 1)).slice(-2)
            + '-'
            + ('0' + date.getDate()).slice(-2)
            + ' '
            + date.toTimeString().slice(0,8);
    }

    get ready() {
        return true;
    }

    get history() {
        return this._history;
    }
}

module.exports = Logger;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Jan 23 2018 09:56:44 GMT+0100 (CET) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
